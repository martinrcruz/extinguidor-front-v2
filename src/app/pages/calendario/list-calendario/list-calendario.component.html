<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Calendario</ion-title>
    <ion-buttons slot="end">
      <ion-button class="back-button" (click)="volver()">
        <ion-icon name="arrow-back-outline"></ion-icon>
        Volver
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- Barra de navegación para el calendario -->
  <div class="calendar-nav">
    <div class="left-buttons">
      <ion-button fill="clear" (click)="previousMonth()">
        <i class="bi bi-arrow-left-circle"></i> Mes
      </ion-button>
    </div>

    <div class="center-display">
      <ion-button class="today-btn" fill="solid" color="danger" (click)="goToday()">
        <ion-icon name="calendar-outline" slot="start"></ion-icon>
        Hoy
      </ion-button>
      <div class="month-year-display">
        {{ viewDate | date: 'MMMM yyyy' }}
      </div>
    </div>

    <div class="right-buttons">
      <ion-button fill="clear" (click)="nextMonth()">
        Mes <i class="bi bi-arrow-right-circle"></i>
      </ion-button>
    </div>
  </div>

  <!-- Días de la semana -->
  <div class="weekdays">
    <div class="weekday" *ngFor="let day of weekDays">{{ day }}</div>
  </div>

  <!-- Calendario mensual -->
  <mwl-calendar-month-view 
    [viewDate]="viewDate"
    [events]="events"
    [refresh]="refresh"
    [cellTemplate]="monthCellTemplate">
  </mwl-calendar-month-view>

  <!-- Template celda calendario (monthCellTemplate) -->
  <ng-template #monthCellTemplate let-day="day">
    <div class="cal-cell" (click)="dayClicked(day)" [ngClass]="{'today': day.isToday}">
      <div class="cal-date" [ngClass]="{'today': day.isToday}">{{ day.date | date:'d' }}</div>
      
      <!-- Mostramos la facturación final en la esquina superior derecha -->
      <div class="fact-sum" *ngIf="getFactSum(day.date) > 0">
        <ion-icon name="cash-outline"></ion-icon> {{ getFactSum(day.date) }} €
      </div>

      <div class="cal-events">
        <!-- Modificamos los iconos para que solo sean visuales y no interactivos -->
        <div class="event-icon" *ngFor="let event of day.events" [attr.data-tooltip]="event.title || 'Ruta'">
          <img src="assets/icon/extintor.png" alt="extintor" />
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Sección inferior dividida en dos columnas -->
  <ion-grid *ngIf="selectedDay">
    <ion-row>
      <ion-col size="12" class="action-bar">
        <ion-button fill="clear" class="back-button" (click)="cancelarSeleccion()">
          <ion-icon name="arrow-back-outline"></ion-icon>
          Volver al calendario
        </ion-button>
      </ion-col>

      <!-- Columna Izquierda: Rutas del día y Detalles -->
      <ion-col size="12" size-md="6">
        <h2>
          <ion-icon name="map-outline"></ion-icon>
          Rutas del {{ selectedDay | dateLocal:'dd-MM-yyyy' }}
        </h2>
        
        <div class="empty-state" *ngIf="(rutasDelDia?.length || 0) === 0">
          <ion-icon name="trail-sign-outline"></ion-icon>
          <h3>No hay rutas para este día</h3>
          <p>No existen rutas programadas para la fecha seleccionada.</p>
          
          <!-- Botón crear ruta, oculto si role=worker -->
          <ion-button expand="block" (click)="createRutaParaDia()" *ngIf="!isWorker">
            <ion-icon slot="start" name="add-outline"></ion-icon>
            Crear Ruta
          </ion-button>
        </div>
        
        <ion-list *ngIf="(rutasDelDia?.length || 0) > 0">
          <ng-container *ngFor="let r of rutasDelDia">
            <ion-item (click)="toggleRuta(r)" [ngClass]="{'ruta-expanded': rutaSeleccionada === r}">
              <ion-icon slot="start" [name]="getTipoRutaIcon(r.type)"></ion-icon>
              <ion-label>
                <h3>{{ r.name?.name || 'Ruta sin nombre' }}</h3>
                <p *ngIf="rutaSeleccionada !== r">{{ r.date }} - {{ r.type }}</p>
                <p *ngIf="rutaSeleccionada === r" style="color: white">{{ r.date }} - {{ r.type }}</p>
              </ion-label>
              <ion-icon slot="end"
                [name]="rutaSeleccionada === r ? 'chevron-up-outline' : 'chevron-down-outline'">
              </ion-icon>
            </ion-item>
      
            <!-- Detalles inmediatamente debajo -->
            <div *ngIf="rutaSeleccionada === r" class="ruta-detalle">
              <h3>{{ r.name?.name || 'Ruta sin nombre' }}</h3>
              <div class="tipo-ruta" [ngClass]="getTipoRutaClass(r.type)">
                <ion-icon [name]="getTipoRutaIcon(r.type)"></ion-icon>
                {{ r.type }}
              </div>
      
              <div class="info-block">
                <ion-icon name="car-outline"></ion-icon>
                <strong>Vehículo:</strong> {{ r.vehicle?.brand }} - {{ r.vehicle?.matricula }}
              </div>
              
              <div class="workers-info">
                <div class="info-label">
                  <ion-icon name="people-outline"></ion-icon>
                  <strong>Trabajadores:</strong>
                </div>
                <div class="chips-container">
                  <ion-chip *ngFor="let t of r.users">
                    <ion-avatar>
                      <ion-icon name="person"></ion-icon>
                    </ion-avatar>
                    <ion-label>{{ t.name }}</ion-label>
                  </ion-chip>
                </div>
              </div>
      
              <!-- Partes Asignados -->
              <ion-accordion-group>
                <ion-accordion value="partsAssigned">
                  <ion-item slot="header">
                    <ion-icon name="document-text-outline" slot="start"></ion-icon>
                    <ion-label>Partes Asignados ({{ partesAsignadosARuta.length }})</ion-label>
                  </ion-item>
                  <div slot="content" class="accordion-content">
                    <div *ngIf="partesAsignadosARuta.length > 0">
                      <ion-card *ngFor="let p of partesAsignadosARuta" class="parte-card">
                        <ion-card-header>
                          <ion-card-title>{{ p.description }}</ion-card-title>
                        </ion-card-header>
                        <ion-card-content>
                          <p><strong>Facturación:</strong> {{ p.facturacion }} €</p>
                        </ion-card-content>
                      </ion-card>
                    </div>
                    <div *ngIf="partesAsignadosARuta.length === 0" class="empty-accordion">
                      <ion-icon name="document-outline"></ion-icon>
                      <p>No hay partes asignados a esta ruta</p>
                    </div>
                  </div>
                </ion-accordion>
              </ion-accordion-group>
      
              <!-- Botón para habilitar asignación, se oculta si role=worker -->
              <ion-button expand="block" fill="solid" color="primary" (click)="enableAssignPartes()" *ngIf="!isWorker">
                <ion-icon slot="start" name="checkbox-outline"></ion-icon>
                Asignar Partes
              </ion-button>
            </div>
          </ng-container>
        </ion-list>
      
        <!-- Botón crear ruta, oculto si role=worker y si ya se mostró en empty state -->
        <ion-button expand="block" (click)="createRutaParaDia()" *ngIf="!isWorker && (rutasDelDia?.length || 0) > 0">
          <ion-icon slot="start" name="add-outline"></ion-icon>
          Crear Ruta
        </ion-button>
      </ion-col>
      

      <!-- Columna Derecha: Partes No Asignados + Filtro -->
      <ion-col size="12" size-md="6">
        <h2>
          <ion-icon name="document-outline"></ion-icon>
          Partes No Asignados
        </h2>
        
        <!-- Filtros en tarjeta con cabecera desplegable -->
        <div class="filter-card">
          <div class="filter-header" (click)="toggleFilters()">
            <h3>
              <ion-icon name="options-outline"></ion-icon>
              Filtros
            </h3>
            <ion-icon class="toggle-icon" [ngClass]="{'expanded': isFilterExpanded}" name="chevron-down-outline"></ion-icon>
          </div>
          
          <div class="filter-content" [ngClass]="{'expanded': isFilterExpanded}">
            <ion-item>
              <ion-icon name="locate-outline" slot="start"></ion-icon>
              <ion-label>Zona</ion-label>
              <ion-select [(ngModel)]="filterZona" placeholder="Todas" (ionChange)="filtrarPartesPendientes()">
                <ion-select-option value="">(Todas)</ion-select-option>
                <ion-select-option *ngFor="let z of zonas" [value]="z._id">
                  {{ z.name }}
                </ion-select-option>
              </ion-select>
            </ion-item>
            
            <ion-item>
              <ion-icon name="pricetag-outline" slot="start"></ion-icon>
              <ion-label>Tipo</ion-label>
              <ion-select [(ngModel)]="filterTipo" placeholder="Todos" (ionChange)="filtrarPartesPendientes()">
                <ion-select-option value="">(Todos)</ion-select-option>
                <ion-select-option value="Obra">Obra</ion-select-option>
                <ion-select-option value="Mantenimiento">Mantenimiento</ion-select-option>
                <ion-select-option value="Correctivo">Correctivo</ion-select-option>
                <ion-select-option value="Visitas">Visitas</ion-select-option>
              </ion-select>
            </ion-item>
            
            <ion-item>
              <ion-icon name="cash-outline" slot="start"></ion-icon>
              <ion-label>Facturación</ion-label>
              <ion-select [(ngModel)]="filterFactRange" placeholder="Todos" (ionChange)="filtrarPartesPendientes()">
                <ion-select-option value="">(Todos)</ion-select-option>
                <ion-select-option value="lt100">Menos de 100€</ion-select-option>
                <ion-select-option value="bt100_500">100€ - 500€</ion-select-option>
                <ion-select-option value="gt500">Más de 500€</ion-select-option>
              </ion-select>
            </ion-item>

            <div class="filter-date-type">
              <ion-item>
                <ion-icon name="filter-outline" slot="start"></ion-icon>
                <ion-label>Tipo de evento</ion-label>
                <ion-select [(ngModel)]="selectedType" (ionChange)="applyFilters()">
                  <ion-select-option value="">Todos los tipos</ion-select-option>
                  <ion-select-option value="ruta">Rutas</ion-select-option>
                  <ion-select-option value="parte">Partes</ion-select-option>
                </ion-select>
              </ion-item>
              
              <app-date-picker
                label="Filtrar por fecha"
                [selectedDate]="selectedDate"
                (dateChange)="onDateChange($event)">
              </app-date-picker>
              
              <ion-button expand="block" (click)="applyFilters()">
                <ion-icon name="checkmark-outline" slot="start"></ion-icon>
                Aplicar Filtros
              </ion-button>
            </div>
          </div>
        </div>

        <!-- Lista de partes no asignados -->
        <div class="parts-list-container">
          <div *ngIf="partesNoAsignados && partesNoAsignados.length > 0">
            <ion-card *ngFor="let p of partesNoAsignados" class="parte-card">
              <ion-card-header>
                <ion-card-title>{{ p.description }}</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <!-- Checkboxes, solo si enableCheckParts y no isWorker -->
                <ion-checkbox [(ngModel)]="p.selected" *ngIf="enableCheckParts && !isWorker"></ion-checkbox>
                
                <ion-grid>
                  <ion-row>
                    <ion-col>
                      <p class="parte-details">
                        <ion-icon name="cash-outline"></ion-icon>
                        <strong>Facturación:</strong> {{ p.facturacion }} €
                      </p>
                    </ion-col>
                  </ion-row>
                  <ion-row>
                    <ion-col>
                      <p class="parte-details">
                        <ion-icon name="construct-outline"></ion-icon>
                        <strong>Tipo:</strong> {{ p.type }} - {{ p.categoria }}
                      </p>
                    </ion-col>
                  </ion-row>
                  <ion-row>
                    <ion-col>
                      <p class="parte-details">
                        <ion-icon name="calendar-outline"></ion-icon>
                        <strong>Fecha:</strong> {{ p.date | dateLocal:'dd/MM/yyyy' }}
                      </p>
                    </ion-col>
                  </ion-row>
                  <ion-row>
                    <ion-col>
                      <p class="parte-details">
                        <ion-icon name="business-outline"></ion-icon>
                        <strong>Cliente:</strong> {{ p.customer.name }}
                      </p>
                    </ion-col>
                  </ion-row>
                  <ion-row *ngIf="p.coordinationMethod">
                    <ion-col>
                      <p class="parte-details">
                        <ion-icon name="time-outline"></ion-icon>
                        <strong>Coordinación:</strong> {{ p.coordinationMethod }}
                      </p>
                    </ion-col>
                  </ion-row>
                  <ion-row *ngIf="p.periodico">
                    <ion-col>
                      <p class="parte-details">
                        <ion-icon name="repeat-outline"></ion-icon>
                        <strong>Tipo:</strong> Periódico
                      </p>
                    </ion-col>
                  </ion-row>
                </ion-grid>
              </ion-card-content>
            </ion-card>
          </div>
          
          <div class="empty-state" *ngIf="!partesNoAsignados || partesNoAsignados.length === 0">
            <ion-icon name="document-text-outline"></ion-icon>
            <h3>No hay partes sin asignar</h3>
            <p>Todos los partes han sido asignados a rutas o no hay partes para el filtro actual.</p>
          </div>
        </div>

        <!-- Botón para asignar, si hay una ruta seleccionada y habilitado check, oculto si worker -->
        <ion-button expand="block" [disabled]="!rutaSeleccionada || !enableCheckParts || getSelectedNoAsignados().length === 0" 
                  *ngIf="enableCheckParts && !isWorker"
                  (click)="asignarPartesARuta(getSelectedNoAsignados())">
          <ion-icon slot="start" name="checkmark-done-outline"></ion-icon>
          Asignar {{ getSelectedNoAsignados().length }} Partes Seleccionados
        </ion-button>
      </ion-col>
    </ion-row>
  </ion-grid>

</ion-content>
