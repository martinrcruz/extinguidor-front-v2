<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Partes de Trabajo</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="exportarExcel()" title="Exportar a Excel">
        <ion-icon name="document-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="exportarPDF()" title="Exportar a PDF">
        <ion-icon name="document-text-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="nuevaParte()">
        <ion-icon name="add-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Barra de búsqueda y filtros -->
  <ion-searchbar 
    (ionInput)="filtrar($event)" 
    placeholder="Buscar parte..." 
    animated 
    class="ion-margin"
    debounce="300">
  </ion-searchbar>

  <ion-card class="filters">
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="12" sizeMd="6">
            <ion-item lines="none">
              <ion-label>Estado</ion-label>
              <ion-select [(ngModel)]="estadoFiltro" (ionChange)="onFiltroChange()" interface="popover">
                <ion-select-option value="">Todos</ion-select-option>
                <ion-select-option value="Pendiente">Pendiente</ion-select-option>
                <ion-select-option value="EnProceso">En Proceso</ion-select-option>
                <ion-select-option value="Finalizado">Finalizado</ion-select-option>
                <ion-select-option value="Cancelado">Cancelado</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>

          <ion-col size="12" sizeMd="6">
            <ion-item lines="none">
              <ion-label>Tipo</ion-label>
              <ion-select [(ngModel)]="tipoFiltro" (ionChange)="onFiltroChange()" interface="popover">
                <ion-select-option value="">Todos</ion-select-option>
                <ion-select-option value="Mantenimiento">Mantenimiento</ion-select-option>
                <ion-select-option value="Correctivo">Correctivo</ion-select-option>
                <ion-select-option value="Visitas">Visitas</ion-select-option>
                <ion-select-option value="Obra">Obra</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-spinner">
    <ion-spinner name="circular"></ion-spinner>
    <p>Cargando partes...</p>
  </div>

  <!-- Lista de partes -->
  <ion-list *ngIf="!isLoading" class="animate-fade-in">
    <ion-card *ngFor="let p of filteredPartes" class="parte-card animate-fade-in">
      <ion-card-header>
        <ion-card-subtitle>
          <ion-chip [ngClass]="getTipoParteClass(p.type)" class="badge">
            {{ p.type }}
          </ion-chip>
          <ion-chip [ngClass]="stateColor(p.state)" class="badge">
            {{ p.state === 'EnProceso' ? 'En Proceso' : p.state }}
          </ion-chip>
        </ion-card-subtitle>
        <ion-card-title>{{ p.title || p.description }}</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <div class="parte-description" *ngIf="p.title && p.description">
          <p>{{ p.description }}</p>
        </div>
        
        <ion-grid>
          <ion-row>
            <ion-col size="12" sizeMd="6">
              <ion-item lines="none">
                <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <p>Fecha</p>
                  <h3>{{ p.date | dateLocal:'dd/MM/yyyy' }}</h3>
                </ion-label>
              </ion-item>
            </ion-col>
            <ion-col size="12" sizeMd="6">
              <ion-item lines="none">
                <ion-icon name="business-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <p>Cliente</p>
                  <h3>{{ getCustomerName(p) }}</h3>
                </ion-label>
              </ion-item>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="12" sizeMd="6">
              <ion-item lines="none">
                <ion-icon name="map-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <p>Ruta</p>
                  <h3>{{ getRutaName(p) }}</h3>
                </ion-label>
              </ion-item>
            </ion-col>
            <ion-col size="12" sizeMd="6">
              <ion-item lines="none">
                <ion-icon name="cash-outline" slot="start" color="success"></ion-icon>
                <ion-label>
                  <p>Facturación</p>
                  <h3>{{ p.facturacion || 0 | currency:'EUR' }}</h3>
                </ion-label>
              </ion-item>
            </ion-col>
          </ion-row>
          <ion-row *ngIf="p.address">
            <ion-col size="12">
              <ion-item lines="none">
                <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <p>Dirección</p>
                  <h3>{{ p.address }}</h3>
                </ion-label>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>

        <div class="parte-actions">
          <ion-button expand="block" (click)="editarParte(p._id || p.id)" class="button-primary">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Editar
          </ion-button>
          
          <ion-button expand="block" fill="outline" color="danger" (click)="eliminarParte(p._id || p.id)" class="delete-btn">
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            Eliminar
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </ion-list>

  <!-- Controles de paginación -->
  <div *ngIf="!isLoading && totalPages > 1" class="pagination-container">
    <ion-grid>
      <ion-row class="ion-align-items-center ion-justify-content-center">
        <ion-col size="12" sizeMd="8" class="ion-text-center">
          <!-- Información de paginación -->
          <div class="pagination-info">
            <p>{{ paginationInfo }}</p>
          </div>
          
          <!-- Controles de navegación -->
          <div class="pagination-controls">
            <ion-button 
              fill="outline" 
              size="small" 
              [disabled]="!hasPrevPage"
              (click)="prevPage()">
              <ion-icon name="chevron-back-outline"></ion-icon>
              Anterior
            </ion-button>
            
            <!-- Indicador de página actual -->
            <ion-chip color="primary" class="page-indicator">
              {{ currentPage + 1 }} / {{ totalPages }}
            </ion-chip>
            
            <ion-button 
              fill="outline" 
              size="small" 
              [disabled]="!hasNextPage"
              (click)="nextPage()">
              Siguiente
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Estado vacío -->
  <div *ngIf="!isLoading && filteredPartes.length === 0" class="empty-state">
    <ion-icon name="document-text-outline"></ion-icon>
    <h3>No hay partes</h3>
    <p>No se encontraron partes que coincidan con los criterios de búsqueda</p>
    <ion-button (click)="nuevaParte()" class="button-primary">
      <ion-icon name="add-circle-outline" slot="start"></ion-icon>
      Crear Primera Parte
    </ion-button>
  </div>
</ion-content>
