<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ isEdit ? 'Editar Parte' : 'Nuevo Parte' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="page-container">
    <div class="header">
      <h1>{{ isEdit ? 'Editar Parte' : 'Nuevo Parte' }}</h1>
    </div>

    <form [formGroup]="parteForm" (ngSubmit)="onSave()" class="form-container">
      <div class="form-section">
        <h2>Información Básica</h2>
        <ion-item>
          <ion-label position="stacked">Título</ion-label>
          <ion-input formControlName="title" placeholder="Título del parte">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Descripción</ion-label>
          <ion-textarea formControlName="description" rows="4" placeholder="Describa el trabajo a realizar">
          </ion-textarea>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Dirección</ion-label>
          <ion-input formControlName="address" placeholder="Dirección del trabajo">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Facturación (€)</ion-label>
          <ion-input formControlName="facturacion" type="number" placeholder="Importe en euros">
          </ion-input>
        </ion-item>
      </div>

      <div class="form-section">
        <h2>Clasificación</h2>
        <ion-item>
          <ion-label position="stacked">Estado</ion-label>
          <ion-select formControlName="state" placeholder="Seleccione estado">
            <ion-select-option value="Pendiente">Pendiente</ion-select-option>
            <ion-select-option value="EnProceso">En Proceso</ion-select-option>
            <ion-select-option value="Finalizado">Finalizado</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Tipo</ion-label>
          <ion-select formControlName="type" placeholder="Seleccione tipo">
            <ion-select-option value="Obra">Obra</ion-select-option>
            <ion-select-option value="Mantenimiento">Mantenimiento</ion-select-option>
            <ion-select-option value="Correctivo">Correctivo</ion-select-option>
            <ion-select-option value="Visitas">Visitas</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Categoría</ion-label>
          <ion-select formControlName="categoria" placeholder="Seleccione categoría">
            <ion-select-option value="Extintores">Extintores</ion-select-option>
            <ion-select-option value="Incendio">Incendio</ion-select-option>
            <ion-select-option value="Robo">Robo</ion-select-option>
            <ion-select-option value="CCTV">CCTV</ion-select-option>
            <ion-select-option value="Pasiva">Pasiva</ion-select-option>
            <ion-select-option value="Venta">Venta</ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <div class="form-section">
        <h2>Planificación</h2>
        <ion-item>
          <ion-label position="stacked">Fecha</ion-label>
          <ion-datetime formControlName="date" [min]="minDate" presentation="date">
          </ion-datetime>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Contratos</ion-label>
          <ion-input placeholder="Buscar cliente..." [(ngModel)]="searchClientTxt" [ngModelOptions]="{standalone: true}"
            (ionInput)="filterCustomers($event)" (click)="openClientModal()" readonly>
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Ruta</ion-label>
          <ion-select formControlName="ruta" placeholder="Seleccione ruta">
            <ion-select-option *ngFor="let r of rutasDisponibles" [value]="r._id">
              {{ r.name?.name || 'Sin nombre' }} - {{ r.date | dateLocal:'dd/MM/yyyy' }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <div class="form-section">
        <h2>Configuración Periódica</h2>
        <ion-item>
          <ion-label>Periódico</ion-label>
          <ion-toggle formControlName="periodico"></ion-toggle>
        </ion-item>

        <div *ngIf="parteForm.get('periodico')?.value">
          <ion-item>
            <ion-label position="stacked">Frecuencia</ion-label>
            <ion-select formControlName="frequency" placeholder="Seleccione frecuencia">
              <ion-select-option value="Mensual">Mensual</ion-select-option>
              <ion-select-option value="Trimestral">Trimestral</ion-select-option>
              <ion-select-option value="Semestral">Semestral</ion-select-option>
              <ion-select-option value="Anual">Anual</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Fecha de Fin</ion-label>
            <ion-datetime formControlName="endDate" presentation="date">
            </ion-datetime>
          </ion-item>
        </div>
      </div>

      <div class="form-section">
        <h2>Detalles Adicionales</h2>
        <ion-item>
          <ion-label position="stacked">Coordinación</ion-label>
          <ion-select formControlName="coordinationMethod" placeholder="Método de coordinación">
            <ion-select-option value="Llamar antes">Llamar antes</ion-select-option>
            <ion-select-option value="Coordinar por email">Coordinar por email</ion-select-option>
            <ion-select-option value="Coordinar según horarios">Coordinar según horarios</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Gestiona (Nº)</ion-label>
          <ion-input formControlName="gestiona" type="number" placeholder="Número de gestión">
          </ion-input>
        </ion-item>
      </div>

      <div class="form-section">
        <h2>Artículos</h2>
        <div formArrayName="articulos">
          <div *ngFor="let articulo of articulosFormArray.controls; let i = index" [formGroupName]="i"
            class="articulo-card">
            <div class="articulo-header">
              <div class="articulo-title">
                <ion-input formControlName="codigo" type="text" placeholder="Código"></ion-input>
                <ion-textarea formControlName="descripcionArticulo" placeholder="Descripción" rows="1"></ion-textarea>
              </div>
              <ion-button fill="clear" color="danger" (click)="eliminarArticulo(i)">
                <ion-icon name="trash-outline"></ion-icon>
              </ion-button>
            </div>
            
            <div class="articulo-content">
              <div class="articulo-data">
                <div class="data-row">
                  <div class="data-field">
                    <label>Cantidad</label>
                    <ion-input formControlName="cantidad" type="number" placeholder="Cant."></ion-input>
                  </div>
                  <div class="data-field">
                    <label>Precio</label>
                    <ion-input formControlName="precioVenta" type="number" placeholder="€"></ion-input>
                  </div>
                </div>
                <div class="data-row">
                  <div class="data-field">
                    <label>Grupo</label>
                    <ion-input formControlName="grupo" type="text" placeholder="Grupo"></ion-input>
                  </div>
                  <div class="data-field">
                    <label>Familia</label>
                    <ion-input formControlName="familia" type="text" placeholder="Familia"></ion-input>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <ion-button expand="block" fill="outline" (click)="openArticulosModal()">
          <ion-icon name="list-outline"></ion-icon>
          Seleccionar Artículos Existentes
        </ion-button>
      </div>

      <div class="form-actions">
        <ion-button expand="block" type="submit" [disabled]="parteForm.invalid">
          {{ isEdit ? 'Actualizar' : 'Crear' }}
        </ion-button>
        <ion-button expand="block" fill="outline" (click)="cancel()">
          Cancelar
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>

<ion-modal [isOpen]="clientModalOpen" (ionModalDidDismiss)="closeClientModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Seleccionar Cliente</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="clientModalOpen = false">Cerrar</ion-button>
        </ion-buttons>
      </ion-toolbar>
      <ion-toolbar>
        <ion-searchbar placeholder="Buscar..." [(ngModel)]="searchClientTxt"
          (ionInput)="filterCustomers($event)"></ion-searchbar>
      </ion-toolbar>
    </ion-header>
    <ion-content class="modal-content">
      <ion-list>
        <ion-item button *ngFor="let c of filteredCustomers" (click)="selectCustomer(c)">
          {{ c.name }} ({{ c.nifCif }})
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para seleccionar artículos -->
<ion-modal [isOpen]="articulosModalOpen" (ionModalDidDismiss)="closeArticulosModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Seleccionar Artículos</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="articulosModalOpen = false">Cerrar</ion-button>
        </ion-buttons>
      </ion-toolbar>
      <ion-toolbar>
        <ion-searchbar placeholder="Buscar artículo..." [(ngModel)]="searchArticuloTxt"
          (ionInput)="filterArticulos($event)"></ion-searchbar>
      </ion-toolbar>
      <!-- Información de paginación -->
      <ion-toolbar *ngIf="articulosPagination">
        <ion-title size="small" style="font-size: 0.9rem;">
          {{ (articulosPagination.currentPage - 1) * articulosPagination.itemsPerPage + 1 }} - 
          {{ Math.min(articulosPagination.currentPage * articulosPagination.itemsPerPage, articulosPagination.totalItems) }} 
          de {{ articulosPagination.totalItems }} artículos
        </ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="modal-content">
      
      <!-- Loading spinner -->
      <div class="ion-padding ion-text-center" *ngIf="articulosLoading">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Cargando artículos...</p>
      </div>

      <!-- Lista de artículos -->
      <ion-list *ngIf="!articulosLoading">
        <ion-item *ngFor="let articulo of articulos" class="articulo-list-item">
          <ion-checkbox slot="start" (ionChange)="toggleArticuloSelection(articulo, $event)"></ion-checkbox>
          <ion-label>
            <h2><span class="codigo-badge">{{ articulo.codigo }}</span> {{ articulo.descripcionArticulo }}</h2>
            <p>
              <ion-badge color="light">{{ articulo.grupo }}</ion-badge>
              <ion-badge color="light">{{ articulo.familia }}</ion-badge>
              <span class="precio">{{ articulo.precioVenta | currency:'EUR':'symbol':'1.2-2' }}</span>
            </p>
          </ion-label>
          <ion-button slot="end" fill="clear" color="primary" (click)="selectArticulo(articulo)">
            <ion-icon name="add-circle-outline"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-list>

      <!-- Controles de paginación -->
      <div class="ion-padding" *ngIf="articulosPagination && articulosPagination.totalPages > 1">
        <ion-grid>
          <ion-row class="ion-align-items-center">
            <ion-col size="12" class="ion-text-center">
              
              <!-- Botón página anterior -->
              <ion-button 
                fill="outline" 
                size="small" 
                [disabled]="!articulosPagination.hasPrevPage"
                (click)="articulosPrevPage()">
                <ion-icon name="chevron-back-outline"></ion-icon>
                Anterior
              </ion-button>

              <!-- Información de página actual -->
              <ion-chip color="primary" style="margin: 0 10px;">
                {{ articulosPagination.currentPage }} / {{ articulosPagination.totalPages }}
              </ion-chip>

              <!-- Botón página siguiente -->
              <ion-button 
                fill="outline" 
                size="small" 
                [disabled]="!articulosPagination.hasNextPage"
                (click)="articulosNextPage()">
                Siguiente
                <ion-icon name="chevron-forward-outline"></ion-icon>
              </ion-button>

            </ion-col>
          </ion-row>
        </ion-grid>
      </div>

      <!-- Botones de acción -->
      <div class="ion-padding" *ngIf="articulosSeleccionados.length > 0">
        <ion-button expand="block" (click)="selectMultipleArticulos()">
          Agregar {{ articulosSeleccionados.length }} artículos seleccionados
        </ion-button>
      </div>
      
      <div class="ion-padding" *ngIf="!articulosLoading && articulos.length === 0">
        <p class="ion-text-center">No se encontraron artículos.</p>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>